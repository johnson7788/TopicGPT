from openai import OpenAI
import tiktoken
import requests
from tqdm import tqdm
import json
import numpy as np

class GetEmbeddingsLocal:
    """
    This class allows to compute embeddings of text using the OpenAI API.
    """

    def __init__(self, client_url="http://192.168.50.189:6303", embedding_model: str = "m3e-base", max_tokens: int = 8191) -> None:
        """
        Constructor of the class.

        Args:
            client: Client.
            embedding_model (str, optional): Name of the embedding model to use.
            tokenizer (str, optional): Name of the tokenizer to use.
            max_tokens (int, optional): Maximum number of tokens to use.

        Note:
            By default, the embedding model "text-embedding-ada-002" is used with the corresponding tokenizer "cl100k_base" and a maximum number of tokens of 8191.
        """

        self.client_url = client_url
        self.embedding_model = embedding_model
        self.max_tokens = max_tokens

    def num_tokens_from_string(self, string: str) -> int:
        """
        Returns the number of tokens in a text string.

        Args:
            string (str): Text string to compute the number of tokens.
            encoding: A function to encode the string into tokens.

        Returns:
            int: Number of tokens in the text string.
        """
        url = f"{self.client_url}/api/tokenizer"
        data = {"texts": string, "model":self.embedding_model}
        # 提交form格式数据
        headers = {'content-type': 'application/json'}
        # 提交form格式数据tokenizer
        r = requests.post(url, data=json.dumps(data), headers=headers)
        res = r.json()
        num_tokens = len(res["data"]["tokenize"]["input_ids"][0])
        return num_tokens

    def compute_number_of_tokens(self, corpus: list[str]) -> int:
        """
        Computes the total number of tokens needed to embed the corpus.

        Args:
            corpus (list[str]): List of strings to embed, where each element in the list is a document.

        Returns:
            int: Total number of tokens needed to embed the corpus.
        """



        num_tokens = 0
        for document in tqdm(corpus):
            num_tokens += self.num_tokens_from_string(document)

        return num_tokens

    def split_doc(self, text):
        """
        Splits a single document that is longer than the maximum number of tokens into a list of smaller documents.

        Args:
            self: The instance of the class.
            text (str): The string to be split.

        Returns:
            List[str]: A list of strings to embed, where each element in the list is a list of chunks comprising the document.
        """

        split_text = []
        split_text.append(text[:self.max_tokens])
        for i in range(1, len(text) // self.max_tokens):
            split_text.append(text[i * self.max_tokens:(i + 1) * self.max_tokens])
        split_text.append(text[(len(text) // self.max_tokens) * self.max_tokens:])
        return split_text

    def split_long_docs(self, text: list[str]) -> list[list[str]]:
        """
        Splits all documents that are longer than the maximum number of tokens into a list of smaller documents.

        Args:
            self: The instance of the class.
            text (list[str]): List of strings to embed, where each element in the list is a document.

        Returns:
            List[list[str]]: A list of lists of strings to embed, where each element in the outer list is a list of chunks comprising the document.
        """

        split_text = []
        for document in tqdm(text):
            if self.num_tokens_from_string(document) > self.max_tokens:
                split_text.append(self.split_doc(document))
            else:
                split_text.append([document])
        return split_text   

    def make_api_call(self, text: str):
        """
        Makes an API call to the OpenAI API to embed a text string.

        Args:
            self: The instance of the class.
            text (str): The string to embed.
        response: CreateEmbeddingResponse(data=[Embedding(embedding=[0.005884603131562471, -0.003562262747436762, 0.0039040790870785713, -0.007312189321964979, -0.01735891029238701, -0.002927221590653062, -0.019905775785446167, -0.03259989619255066, -0.0138201043009758, -0.02884661965072155, 0.011889847926795483, 0.018954051658511162, -0.009557453915476799, 0.010830886662006378, -9.514098201179877e-05, -0.00769421923905611, 0.03466419875621796, -0.003642690135166049, 0.028256818652153015, -0.0051339478231966496, 0.00046748414752073586, -0.0013412941480055451, 0.001246624393388629, -0.014101600274443626, -0.0064811063930392265, 0.02008003555238247, 0.013598929159343243, -0.0015272824093699455, 0.004782077856361866, -0.007767944596707821, 0.036326367408037186, -0.01499970629811287, -0.0160586666315794, -0.010442154482007027, -0.022935207933187485, -0.006149343214929104, -0.003359518712386489, -0.0047787269577383995, 0.012787953019142151, -0.03225138038396835, 0.02682253159582615, 0.014812042005360126, -0.0006040431326255202, 0.017801260575652122, 0.006370518822222948, 0.01717124506831169, -0.007794753648340702, -0.015401843003928661, -0.007600387558341026, 0.008284020237624645, -0.002233535284176469, 0.003609178587794304, -0.013558715581893921, 0.016018453985452652, -0.005314909387379885, 0.037720441818237305, -0.00875317957252264, 0.03597784787416458, 0.008015928789973259, -0.033672261983156204, -0.01671549119055271, 0.036085084080696106, -0.048390474170446396, -0.009349683299660683, -0.0006647825357504189, -0.0002881981199607253, -0.017761046066880226, -0.017211459577083588, 0.009041378274559975, 0.007908692583441734, 0.013203495182096958, 0.023350749164819717, -0.015589507296681404, 0.0021765660494565964, 0.05651363730430603, -0.008565516211092472, -0.0219566747546196, 0.020535791292786598, 0.004202330484986305, -0.001249975524842739, 0.0031584501266479492, -0.01711762696504593, -0.013994364067912102, 0.03501271829009056, 0.011769206263124943, 0.024597372859716415, -0.016648467630147934, 0.01383350882679224, -0.03372588008642197, -0.017586786299943924, -0.0031098586041480303, 0.014838851056993008, 0.024088000878691673, 0.012888487428426743, 0.0007799779996275902, 0.031822431832551956, -0.008572218008339405, 0.006209664046764374, -0.02545526623725891, -0.03241223469376564, -0.016728894785046577, -0.004001262132078409, -0.02503972500562668, -0.008183485828340054, -0.04281417652964592, -0.00023206650803331286, 0.004946283996105194, -0.01796211488544941, 0.03458377346396446, -0.012573480606079102, -0.019704708829522133, 0.019436616450548172, 0.0249727014452219, -0.030642831698060036, -0.03142029792070389, -0.03160795941948891, 0.0018716121558099985, -0.025736762210726738, -0.019972799345850945, -0.031125396490097046, -0.0010480693308636546, 0.04380611330270767, 0.03243904188275337, 0.008639240637421608, 0.006853083148598671, -0.010267895646393299, -0.012178045697510242, -0.00922233983874321, 0.003924185875803232, -0.006474404130131006, 3.594622103264555e-05, 0.021326659247279167, 0.029168330132961273, 0.005938221700489521, -0.03729149326682091, 0.001885016681626439, -0.0011779259657487273, -0.022908398881554604, -0.006524671334773302, -0.005505924113094807, 0.011286642402410507, 0.022412430495023727, -0.022519666701555252, 0.0038303539622575045, -0.013102960772812366, -0.014731614850461483, 0.006796113681048155, 0.008203593082726002, 0.003920834511518478, 0.004597765393555164, -0.004101796541363001, -0.006028702482581139, 0.017064008861780167, -0.0170506052672863, 0.019275762140750885, 0.021809224039316177, -0.009611072018742561, 0.006464350502938032, -0.016286544501781464, -0.003639339003711939, 0.01753316819667816, 0.002957381773740053, 0.016366971656680107, -0.007245166227221489, -0.007546768989413977, 0.031795624643564224, 0.014785232953727245, 0.009939483366906643, 0.008733073249459267, 0.01642058975994587, -0.0017945358995348215, 0.025803783908486366, -0.014476927928626537, 0.017037199810147285, 0.017895091325044632, 0.03637998551130295, -0.015455461107194424, 0.005224428605288267, -0.0316883884370327, 0.01062981877475977, -0.024114809930324554, -0.008223699405789375, 0.035119954496622086, 0.022077316418290138, -0.004768673330545425, -0.006812869105488062, 0.023806504905223846, 0.0008654320845380425, 0.0007439532782882452, -0.0043162694200873375, 0.014986301772296429, -0.006853083148598671, -0.007265273481607437, -0.012560076080262661, -0.6108191609382629, 0.010824184864759445, 0.008565516211092472, 0.005918114446103573, 0.010857696644961834, 0.02884661965072155, -0.005150703247636557, 0.003361194161698222, -0.014905874617397785, -0.047184061259031296, -0.019570661708712578, 0.013793295249342918, -0.00401466665789485, -0.01347158569842577, 0.007419425528496504, -0.018860220909118652, 0.01069013960659504, 0.012707525864243507, -0.018498297780752182, 0.0135185020044446, -0.005033413413912058, 0.02935599349439144, -0.014570760540664196, 0.005837687291204929, -0.0025820538867264986, 0.01786828227341175, 0.007137930020689964, -0.007050800137221813, -0.017157841473817825, 0.019463425502181053, -0.0015834140358492732, 0.026715295389294624, 0.0017945358995348215, -0.006269984412938356, 0.06868498027324677, -0.028310436755418777, -0.008096355944871902, 0.02503972500562668, 0.013699463568627834, 0.02343117631971836, -0.02294861152768135, -0.030910922214388847, 0.006956968456506729, -0.011809419840574265, -0.013324135914444923, -0.015147156082093716, 0.005526031367480755, 0.01276114396750927, -0.0008151649963110685, 0.008719668723642826, 0.031339868903160095, -0.004155414644628763, -0.0008327584946528077, -0.008411363698542118, 0.01394074596464634, -0.01394074596464634, 0.017278481274843216, -0.038176197558641434, 0.0007334809633903205, 0.0162329263985157, 0.016313353553414345, 0.02020067721605301, -0.01635356806218624, 0.005187565926462412, -0.026795722544193268, 0.022063910961151123, -0.03190286085009575, -0.017707427963614464, -0.006551480386406183, -0.0010589604498818517, -0.010422048158943653, 0.010576200671494007, 0.00254351575858891, 0.00022808702487964183, 0.02285478077828884, 0.015281202271580696, 0.017761046066880226, -0.0025150312576442957, -0.007426128257066011, 0.016862940043210983, 0.017157841473817825, -0.007198250386863947, -0.005753908772021532, -0.009745117276906967, 0.021541133522987366, 0.005023360252380371, -0.007821562699973583, -0.017372313886880875, 0.01537503395229578, -0.011722290888428688, 0.009477025829255581, 0.007064204663038254, 0.005452306009829044, -0.011145894415676594, -0.012285281904041767, 0.02422204613685608, -0.029490038752555847, 0.0054891686886549, -0.002521733520552516, -0.037237875163555145, -0.014731614850461483, -0.010549391619861126, 0.04924836382269859, 0.002977488562464714, 0.031339868903160095, 0.015468865633010864, -0.031152205541729927, -0.0028585230465978384, 0.017667213454842567, -0.009966292418539524, 0.009838948957622051, -0.01796211488544941, -0.0017694022972136736, -0.0025602716486901045, -0.0033226560335606337, -0.024356091395020485, -0.0018649098929017782, -0.008820202201604843, 0.02183603309094906, -0.004198979586362839, -0.013793295249342918, 0.002654103562235832, 0.052385032176971436, -0.016286544501781464, -0.00606891606003046, 0.03072325885295868, 0.014436714351177216, 0.010288001969456673, 0.023685863241553307, -0.027774255722761154, -0.0017928603338077664, 0.019798539578914642, 0.001806264859624207, -0.018283823505043983, 0.005686886142939329, 0.009262553416192532, 0.011239726096391678, -0.006045457907021046, 0.018069351091980934, -0.018967457115650177, -0.015308011323213577, -0.0054891686886549, 0.0006894972175359726, -0.02424885518848896, -0.0015867651673033834, -0.024235449731349945, 0.026326561346650124, -0.010797375813126564, -0.004520689137279987, 0.0013622387778013945, -0.022868184372782707, -0.015777170658111572, -0.007446235045790672, 0.01028130017220974, 0.013116365298628807, -0.0035723161417990923, 0.004135307855904102, -0.013317433185875416, -0.03458377346396446, -0.015066728927195072, -0.005093734245747328, -0.0025569205172359943, 0.0031634769402444363, -0.009859056212008, -0.01069013960659504, -0.016822727397084236, 0.006045457907021046, 0.021849438548088074, -0.01431607361882925, -0.020173868164420128, -0.0016621658578515053, -0.0037063616327941418, -0.018042542040348053, -0.002674210350960493, -0.021514324471354485, -0.0051238941960036755, -0.017640404403209686, -0.002650752430781722, -0.001361400936730206, -0.005435550585389137, 0.004621223080903292, 0.010013208724558353, -0.012117724865674973, -0.0015239312779158354, 0.03096454031765461, -0.006233121734112501, 0.0034248658921569586, 0.01856531947851181, -0.01699698530137539, 0.028015537187457085, 0.01808275654911995, 0.009745117276906967, -0.0227341391146183, -0.0022268330212682486, 0.013686059042811394, 0.03359183669090271, 0.011963572353124619, -0.0032941712997853756, 0.014852256514132023, -0.0049697416834533215, 0.005214374978095293, 0.005938221700489521, -0.031581152230501175, -0.0012633800506591797, 0.024503542110323906, -0.03967750817537308, 0.023082658648490906, 0.0009115103166550398, 0.015616316348314285, 0.014490332454442978, -0.014476927928626537, -0.012171342968940735, -0.0020173867233097553, -0.02439630590379238, 0.00437658978626132, 0.027077218517661095, -0.03195647895336151, 0.03238542377948761, 0.003894025692716241, 0.0235518179833889, 0.011635161004960537, -0.02029450796544552, 0.0022921802010387182, -0.00599519070237875, -0.010609711520373821, 0.02911471202969551, 0.007292082533240318, 0.019932584837079048, -0.0010681761195883155, -0.02061621844768524, -0.0174795500934124, 0.00303110689856112, -0.0007628034218214452, 0.01361903641372919, 0.018726175650954247, -0.0005583838210441172, 0.007379211951047182, -0.02881981059908867, 0.015053324401378632, 0.0027982026804238558, -0.008934141136705875, 0.0025636227801442146, 0.022868184372782707, -0.023967359215021133, -0.0009374816436320543, 0.0020240889862179756, 0.041286054998636246, 0.008270615711808205, -0.011789313517510891, 0.022050507366657257, -0.0087397750467062, 0.014061386696994305, -0.02788149192929268, -0.007640601135790348, 0.012781251221895218, -0.03624593839049339, -0.009557453915476799, 0.0010271247010678053, 0.026326561346650124, 0.029409611597657204, 0.012405923567712307, 0.018498297780752182, 0.0011511169141158462, -0.009731712751090527, 0.017801260575652122, -0.002422874793410301, 0.002391038928180933, -0.036594457924366, 0.021567942574620247, -0.01781466417014599, 0.008036036044359207, -0.026661675423383713, 0.003944292664527893, -0.02473141998052597, 0.012955510057508945, 0.0009617774048820138, 0.006501213181763887, 0.005267993547022343, 0.01416862290352583, 0.02521398290991783, -0.026045067235827446, -0.0007665734738111496, 0.015254393219947815, 0.028712574392557144, 0.005552840419113636, 0.003867216408252716, -0.017345504835247993, 0.02473141998052597, 0.006008595693856478, 0.005251237656921148, -0.025348028168082237, -0.0027613400015980005, -0.0063571142964065075, 0.003468430833891034, -0.026420393958687782, 0.014758423902094364, 0.03541485592722893, -0.010897910222411156, -0.029248757287859917, -0.011635161004960537, 0.0116887791082263, -0.013994364067912102, -0.014329478144645691, -0.040776681154966354, 0.002345798537135124, 0.0174795500934124, -0.028015537187457085, -0.0213132556527853, 0.006223068572580814, -0.0023256917484104633, -0.0004109336296096444, -0.0007820724858902395, -0.006045457907021046, -0.011266535148024559, -0.011045360006392002, 0.0021464056335389614, -0.024744823575019836, -0.015509079210460186, 0.018404465168714523, 0.00514735234901309, -0.007493150886148214, -0.011018550954759121, -0.0446908138692379, 0.009376492351293564, 0.05254588648676872, 0.011346963234245777, 0.01233890000730753, 0.012090915814042091, 0.02857852913439274, -0.008310829289257526, -0.014342882670462132, -0.025616120547056198, 0.019114907830953598, -0.0013287273468449712, 0.026782317087054253, 0.007171441335231066, -0.019114907830953598, -0.010093635879456997, 0.015602911822497845, -0.022425834089517593, 0.014986301772296429, -0.027613399550318718, 0.002982515376061201, 0.001881665550172329, 0.01995939388871193, 0.004410101100802422, 0.01028130017220974, 0.015777170658111572, 0.0021212720312178135, 0.02682253159582615, 0.015106942504644394, 0.027613399550318718, 0.013190090656280518, -0.02648741751909256, 0.0020777073223143816, -0.0019503639778122306, 0.016648467630147934, 0.001911825849674642, 0.0007054151501506567, 0.00732559384778142, 0.003233850933611393, 0.026862744241952896, 0.01671549119055271, 0.025294410064816475, 0.015830788761377335, 0.02467780001461506, 0.005187565926462412, -0.01786828227341175, 0.016983581706881523, -0.009068187326192856, -0.008123164996504784, 0.026688484475016594, -0.015777170658111572, -0.007379211951047182, 0.03222456946969032, 0.010998443700373173, -0.01717124506831169, -0.016554635018110275, 0.017975518479943275, -0.00882690493017435, -0.011246428824961185, -0.0005118867848068476, -0.022774353623390198, -0.01726507768034935, 0.008498492650687695, -0.021219423040747643, 0.006608449853956699, -0.007660707924515009, -0.00479883374646306, -0.00837785191833973, -0.0105694979429245, 0.003151747863739729, 0.003689605975523591, 0.00886041671037674, 0.009926078841090202, -0.0034198390785604715, -0.019007669761776924, -0.024289067834615707, -0.0189004335552454, 0.019785135984420776, -0.015602911822497845, 0.01035502552986145, -0.0014979599509388208, 0.016487613320350647, 0.010468963533639908, -0.00733899837359786, -0.02046876773238182, -0.028524911031126976, -0.016246329993009567, 0.011253130622208118, 0.027197858318686485, -0.01290859468281269, -0.009041378274559975, -0.0026809126138687134, 0.0020408446434885263, 0.007392616476863623, 0.01962427981197834, 0.012828166596591473, -0.016366971656680107, -0.0005898007657378912, -0.011246428824961185, 0.0008888901211321354, 0.0032506065908819437, -0.012694121338427067, 0.020066631957888603, -0.03120582364499569, -0.04133967310190201, -0.01348499022424221, -0.0028132826555520296, -0.014745019376277924, 0.011541329324245453, -0.005660076625645161, 0.0031953128054738045, -0.003917483612895012, 0.031152205541729927, -0.0028367408085614443, 0.0014828798593953252, 0.01360563188791275, 0.001199708436615765, 0.0341012105345726, 0.00141166802495718, 0.01569674350321293, 0.002573676174506545, 0.006822922732681036, -0.024516945704817772, -0.023511603474617004, 0.01418202742934227, 0.031581152230501175, -0.009477025829255581, -0.0038839722983539104, -0.003615880850702524, -0.022626902908086777, 0.0007556822383776307, 0.008364447392523289, 0.0026272942777723074, 0.018163183704018593, -0.022332001477479935, -0.015334820374846458, -0.05077648535370827, -0.014423309825360775, 0.009108400903642178, 0.01142739038914442, 0.0031467212829738855, -0.026232730597257614, -0.03544166684150696, -0.01678251288831234, -0.02155453711748123, 0.022559879347682, 0.06889945268630981, -0.03281437233090401, -0.008585622534155846, -0.01627313904464245, -0.02219795621931553, 0.00831753108650446, 0.014879065565764904, -0.005445603746920824, 0.0053249625489115715, 0.01608547568321228, -2.013302582781762e-05, -0.01935618929564953, -0.00691675441339612, -0.038658760488033295, 0.010837589390575886, 0.012365709990262985, 0.010086934082210064, -0.005804175976663828, 0.009852354414761066, 6.660392682533711e-05, 0.006796113681048155, -0.011031955480575562, -0.00882690493017435, -0.0012273553293198347, -0.023900335654616356, 0.03072325885295868, 0.029972603544592857, 0.015442056581377983, -0.010971634648740292, 0.01165526732802391, -0.014450118876993656, 0.02343117631971836, -0.0027077216655015945, 0.013143174350261688, -0.018632343038916588, -0.053805917501449585, 0.0325462780892849, -0.018122969195246696, -0.015656528994441032, -0.006132587790489197, 0.0018917189445346594, -0.02709062211215496, 0.02887342870235443, -0.0014920954126864672, 0.026433799415826797, 0.012332198210060596, 0.004175521433353424, -0.016286544501781464, 0.003863865276798606, -0.0038772698026150465, -0.017077414318919182, -0.004081689286977053, -0.00018441746942698956, -0.02183603309094906, -0.017131032422184944, 0.026380181312561035, 0.018860220909118652, 0.011588244698941708, 0.002464764053002, -0.013712868094444275, 0.01069013960659504, 0.0017375665483996272, -0.0160586666315794, -0.005076978355646133, -0.013056044466793537, -0.014919279143214226, 0.0037566288374364376, -0.010676734149456024, -0.0062197172082960606, -0.03385992720723152, 0.00875317957252264, 0.004808886907994747, -0.0116887791082263, 0.013692761771380901, 0.002032466931268573, -0.00839125644415617, -0.0026440501678735018, 0.002873603254556656, 0.014101600274443626, -0.01323030423372984, 0.038229815661907196, 0.04238522797822952, -0.002221806440502405, -0.007707623764872551, -0.05704982206225395, 0.03144710510969162, -0.0003378368855919689, 0.027532972395420074, 0.05174161493778229, 0.0060186488553881645, -0.009135209955275059, 0.0003656932385638356, 0.010086934082210064, -0.011514520272612572, -0.011179406195878983, 0.018310632556676865, 0.03265351429581642, 0.016340162605047226, -0.012157938443124294, -0.011279939673841, -0.008907332085072994, 0.021474109962582588, -0.015428652055561543, -0.011259833350777626, -0.032760754227638245, -0.010489070788025856, -0.014061386696994305, 0.01065662782639265, 0.0015180667396634817, -0.003914132248610258, 0.023659054189920425, -0.011594947427511215, -0.006008595693856478, -0.02600485272705555, -0.014329478144645691, 0.0345301553606987, 0.013491692952811718, 0.034422919154167175, -0.011011848226189613, 0.017948709428310394, -0.02065643109381199, 0.021782414987683296, -0.02321670390665531, -0.02246604859828949, -0.014812042005360126, 0.043886538594961166, -0.026862744241952896, -0.016728894785046577, 0.003076347289606929, -0.00987246073782444, 0.028015537187457085, 0.014919279143214226, -0.005137298721820116, -0.005281398072838783, -0.017224863171577454, -0.008263912983238697, 0.007989119738340378, -0.012499755248427391, -0.004185575060546398, -0.005807526875287294, 0.0017761046765372157, -0.02591102011501789, -0.0016965150134637952, -0.023055849596858025, 0.019007669761776924, 0.015777170658111572, -0.0017761046765372157, -0.02089771442115307, 0.0064040301367640495, -0.005318260286003351, 0.0053249625489115715, -0.004359834361821413, -0.008599027059972286, 0.00875317957252264, -0.016943367198109627, 0.04302864894270897, 0.0013873722637072206, -0.006997182033956051, 0.003766682231798768, 0.016702085733413696, 0.005757260136306286, -0.027613399550318718, 0.007928798906505108, -0.025053128600120544, -0.009899269789457321, -0.03187604993581772, -0.0032757401932030916, 0.005763962399214506, -0.028712574392557144, 0.022533070296049118, 0.05587022006511688, 0.0075199599377810955, 0.00011079708929173648, -0.02140708826482296, -0.025079937651753426, -0.001935283769853413, -0.01726507768034935, -0.0038839722983539104, 0.0013873722637072206, -0.020495576784014702, 0.01347158569842577, -0.005914763547480106, 0.014584165066480637, -0.00799582153558731, 0.0033209805842489004, -0.025495478883385658, -0.010670032352209091, 0.02119261398911476, 0.001967119751498103, 0.0007104418473318219, -0.03828343376517296, 0.0057103438302874565, -0.01772083342075348, 0.019302571192383766, -0.011018550954759121, -0.003642690135166049, 0.01983875408768654, 0.017828069627285004, 0.002516706706956029, 0.0007112796301953495, 0.0083309356123209, 0.0010673383949324489, -0.0076271966099739075, -0.0070575024001300335, -0.02793511003255844, -0.01781466417014599, -0.030910922214388847, 0.03096454031765461, 0.02294861152768135, 0.010636520572006702, 0.0038370562251657248, -0.0027931758668273687, -0.011447496712207794, -0.02983855828642845, 0.01241262536495924, 0.025589311495423317, 0.016018453985452652, -0.008458279073238373, -0.012224962003529072, 0.029758131131529808, -0.014329478144645691, 0.00507362699136138, -0.019731517881155014, -0.014892470091581345, -0.010535987094044685, -0.006638609804213047, -0.0189004335552454, -0.000426013779360801, -0.029892176389694214, 0.010381834581494331, 0.00851189810782671, 0.017439337447285652, -0.003357843030244112, 0.022640306502580643, 0.004845749586820602, 0.0080293333157897, 0.009590964764356613, -0.0054321992211043835, -0.0035455068573355675, -0.021567942574620247, 0.021447300910949707, -0.02150091901421547, -0.026380181312561035, 0.013357647694647312, 0.009262553416192532, -0.003305900376290083, 0.004108498804271221, 0.009671391919255257, -0.019128311425447464, -0.006186205893754959, -0.0008130705100484192, -0.03528080880641937, 0.004711703862994909, -0.020696645602583885, 0.006487808655947447, -0.0026055120397359133, 0.010475666262209415, 0.024423114955425262, 0.0014049657620489597, -0.029221948236227036, -0.016769109293818474, -0.017372313886880875, -0.03624593839049339, 0.009530644863843918, 0.01277454849332571, -0.009376492351293564, 0.013632440939545631, -0.0017258374718949199, 0.027801064774394035, 0.01283486932516098, -0.01050917711108923, -0.02210412546992302, -0.008639240637421608, -0.00035961929825134575, 0.001133523415774107, 0.01774764247238636, 0.0050099557265639305, 0.002193321706727147, 0.003225472988560796, -0.030321121215820312, 0.012191450223326683, -0.019691303372383118, 0.013009128160774708, -0.01659484952688217, -0.020978141576051712, -0.0007142118993215263, -0.0005022522527724504, -0.0345301553606987, -0.0036594457924365997, -0.01289519015699625, 0.011393878608942032, 0.019905775785446167, 0.3024069368839264, -0.009818842634558678, -0.014208837412297726, 0.02566973865032196, 0.0286321472376585, 0.052385032176971436, 0.031152205541729927, 0.008210294879972935, -0.009912674315273762, 0.021809224039316177, -0.0054020388051867485, -0.01395415049046278, 0.0010790673550218344, -0.0024848708417266607, 0.01642058975994587, -0.03195647895336151, -0.017452741041779518, -0.020240889862179756, -0.018431274220347404, -0.03281437233090401, 0.021581346169114113, -0.010783971287310123, -0.017787855118513107, -0.02615230344235897, 0.01871277019381523, 0.004413452465087175, -0.019731517881155014, -0.014141813851892948, 0.027774255722761154, 0.006822922732681036, -0.03270713612437248, -0.001953714992851019, 0.018632343038916588, 0.001182114938274026, -0.020093441009521484, 0.018364252522587776, 0.008505195379257202, 0.002416172530502081, 0.013706166297197342, -0.006022000219672918, -0.0075668757781386375, -0.025294410064816475, 0.027801064774394035, -0.027801064774394035, 0.006132587790489197, 0.0035019421484321356, -0.026500821113586426, -0.005097085144370794, 0.0038504607509821653, 0.007218357175588608, -0.018994266167283058, 0.002873603254556656, 0.008793393149971962, 0.01354531105607748, -0.00018232299771625549, 0.013022533617913723, 0.028551720082759857, -0.003790140151977539, -0.03385992720723152, 0.00020159206178504974, 0.015468865633010864, 0.027197858318686485, -0.035816993564367294, -0.012707525864243507, -0.012070809490978718, 0.0029104657005518675, -0.018820006400346756, -0.0056165121495723724, -0.004460368305444717, -0.01774764247238636, -0.0091486144810915, -0.023176489397883415, -0.00606221379712224, 0.01105206273496151, -0.03120582364499569, -0.01276114396750927, 0.028551720082759857, 0.018310632556676865, 0.01723826862871647, 0.04705001786351204, -0.009001163765788078, -0.004339727573096752, 0.0101606585085392, -0.020428555086255074, 0.008726370520889759, -0.0381493866443634, 0.02083069086074829, -0.004540795926004648, -0.035334426909685135, -0.019878966733813286, 0.0007108607678674161, -0.016031857579946518, 0.00017363097867928445, -0.012365709990262985, 0.01627313904464245, -0.006022000219672918, 0.0015733606414869428, 0.014061386696994305, -0.012667312286794186, -0.01247294619679451, -0.019034480676054955, 0.02143389731645584, 0.017694024369120598, 0.0116887791082263, -0.017077414318919182, -0.019396403804421425, 0.00282333604991436, 0.004309567157179117, 0.013250410556793213, -0.011594947427511215, -0.007861776277422905, -0.04241203889250755, 0.01536162942647934, -0.0054422528482973576, -0.004339727573096752, -0.006216366309672594, 0.0011217943392693996, -0.017694024369120598, -0.010609711520373821, -0.03721106797456741, 0.027506163343787193, -0.012982319109141827, 0.0005144001333974302, 0.017090817913413048, -0.018297228962183, -0.030589213594794273, -0.02833724580705166, 0.011695481836795807, -0.0003874756512232125, -0.04254608228802681, 0.02167517878115177, -0.01871277019381523, 0.00987246073782444, -0.012251771055161953, -0.003535453462973237, 0.012030595913529396, -0.008679455146193504, 0.01741252839565277, -0.007586982566863298, 0.004637978971004486, -0.004651383496820927, 0.006598396226763725, 0.0025066533125936985, -0.00988586526364088, 0.026286348700523376, -0.0015716850757598877, 0.030079839751124382, 0.032304998487234116, 0.03190286085009575, -0.0024346038699150085, -0.0043933456763625145, 0.010884505696594715, -0.006189557258039713, -0.020267698913812637, 0.02403438277542591, -0.0005315747112035751, -0.05018668621778488, -0.006715686060488224, 0.008987759239971638, -0.00471840612590313, -0.03222456946969032, -0.03139348700642586, 0.03753277659416199, 0.011380474083125591, -0.03412801772356033, 0.010093635879456997, -0.17147117853164673, 0.013371052220463753, 0.002205050550401211, -0.03691616654396057, 0.0257903803139925, -1.0439589459565468e-05, 0.022667115554213524, 0.006042107008397579, -0.014450118876993656, -0.02065643109381199, 0.0063939765095710754, -0.01868596114218235, -0.021125592291355133, -0.015951430425047874, 0.017064008861780167, 0.00408839201554656, -0.030160266906023026, 0.020053226500749588, 0.028953855857253075, 0.006420785561203957, 0.031179014593362808, -0.00044318835716694593, -0.015509079210460186, 0.03471782058477402, 0.001754322205670178, 0.015106942504644394, 0.012707525864243507, -0.0004884287482127547, 0.0040548802353441715, -0.016165902838110924, -0.020026417449116707, 0.00641743466258049, 0.0019486884120851755, 0.00768081471323967, 0.028095964342355728, 0.0056634279899299145, 0.0035186978057026863, 0.003997910767793655, 0.004433559253811836, 0.007271975744515657, 0.003840407356619835, 0.039355795830488205, -0.00535177206620574, 0.02013365365564823, -0.0036192319821566343, 0.013659249991178513, 0.017318695783615112, -0.009926078841090202, -0.010877802968025208, 0.0008197728311643004, -0.005368527490645647, -0.013793295249342918, 0.033216506242752075, 0.003615880850702524, 0.014007768593728542, 0.0020257646683603525, -0.01575036160647869, 0.0013203495182096958, -0.01587100327014923, 0.014812042005360126, -0.00606221379712224, -0.02135346829891205, 0.004031422547996044, 0.017198054119944572, -0.00922233983874321, -0.01572355255484581, -0.018954051658511162, 0.004135307855904102, -0.01774764247238636, 0.005257939919829369, -0.004812238272279501, -0.010924719274044037, 0.01711762696504593, -0.005197619553655386, 0.004426856990903616, 0.023900335654616356, -0.007204952649772167, 0.009242446161806583, 0.007452937308698893, 0.0031651523895561695, 0.014530546963214874, 0.0007133741164579988, -0.022211361676454544, 0.007225059438496828, 0.0014812042936682701, 0.008940843865275383, 0.03377949818968773, -0.012452838942408562, 0.029463229700922966, -0.02352500893175602, 0.01835084706544876, -0.02309606224298477, -0.02817639149725437, -0.011152596212923527, -0.007064204663038254, 0.008552111685276031, 0.026675080880522728, 0.010401940904557705, -0.017399122938513756, -0.01671549119055271, -0.006729090586304665, -0.0003108183154836297, -0.01793530583381653, 0.023659054189920425, 0.017761046066880226, -0.019275762140750885, 0.003914132248610258, 0.022600093856453896, 0.02612549439072609, -0.03637998551130295, -0.02331053465604782, 0.019342783838510513, 0.022667115554213524, 0.03385992720723152, 0.0004071636067237705, 0.018002327531576157, 0.001276784692890942, -0.023846717551350594, 0.019208738580346107, 0.005492519587278366, -0.036755312234163284, -0.01668868213891983, 0.0043933456763625145, 0.03353821858763695, 0.005371878854930401, -0.01251986250281334, -0.05763962119817734, -0.017787855118513107, 0.029007473960518837, 0.014543951489031315, -0.007821562699973583, 0.023337343707680702, -0.004389994312077761, 0.03195647895336151, -0.020173868164420128, 0.018913839012384415, -0.028498101979494095, -0.027532972395420074, -0.021822629496455193, -0.0018515052506700158, 0.01164186280220747, -0.02065643109381199, 0.023109467700123787, -0.031822431832551956, -0.008900630287826061, 0.035093147307634354, -0.003326007165014744, -0.01892724260687828, 0.0007963148527778685, 0.010750459507107735, -0.02367245778441429, 0.008558813482522964, -0.0062197172082960606, 0.0131096625700593, 0.0029322481714189053, 0.01165526732802391, 0.027827873826026917, -0.024637587368488312, 0.016018453985452652, -0.016795918345451355, 0.008779988624155521, -0.0046245744451880455, -0.00837785191833973, -0.013250410556793213, 0.020884308964014053, -0.010609711520373821, 0.015924621373414993, 0.009905972518026829, 0.04396696761250496, -0.02261349745094776, 0.005606458522379398, -0.019610876217484474, -0.02745254524052143, 0.01928916573524475, 0.015334820374846458, -0.01499970629811287, -0.0276402086019516, -0.00910169817507267, -0.032010097056627274, -0.0036024763248860836, 0.013377754017710686, -0.033216506242752075, 0.0043698875233531, 0.012305389158427715, -0.006641961168497801, 0.006812869105488062, -0.005174161400645971, -0.015736958011984825, -0.04300183802843094, 0.009470324032008648, 0.022962016984820366, -0.00219164602458477, -0.019878966733813286, 0.013290624134242535, -0.005083680618554354, 0.0062498776242136955, -0.022868184372782707, 0.005020008888095617, -0.015133751556277275, 0.036085084080696106, -0.036782123148441315, -0.016836130991578102, 0.010254491120576859, -0.006507915444672108, 0.010676734149456024, 0.004694948438555002, -0.020026417449116707, -0.013873723335564137, -0.019972799345850945, -0.024624181911349297, 0.02041514962911606, 0.015240988694131374, 0.013679356314241886, 0.010609711520373821, 0.007660707924515009, -0.020173868164420128, -0.017010390758514404, 0.010040017776191235, 0.03327012434601784, -0.020495576784014702, 0.0018364251591265202, 0.015321415849030018, -0.002731179818511009, 0.00183307402767241, 0.028927046805620193, -0.01853851042687893, -0.015455461107194424, -0.03335055336356163, -0.059248168021440506, -0.007734432816505432, 0.007493150886148214, 0.008632538840174675, 0.008411363698542118, -0.009376492351293564, 0.008880523033440113, -0.007707623764872551, 0.00012210718705318868, -0.013525204733014107, -0.0035991251934319735, -0.010033315978944302, -0.004279406741261482, -0.021903056651353836, -0.011078871786594391, 0.0013672654749825597, -0.002649076748639345, 0.00887382123619318, 0.007191548123955727, 0.014798637479543686, 0.0020425203256309032, -0.0030126755591481924, -0.012593586929142475, -0.01129334419965744, 0.002977488562464714, -0.0005973408697172999, -0.017975518479943275, 0.024088000878691673, -0.018551915884017944, -0.008015928789973259, -0.005690237041562796, 0.0012147885281592607, 0.01781466417014599, 0.007747837342321873, -0.02294861152768135, -0.03597784787416458, 0.01608547568321228, 0.02412821352481842, -0.005733801983296871, 0.022667115554213524, -0.004148712381720543, -0.02386012300848961, 0.022787757217884064, -0.010985039174556732, -0.014610974118113518, -0.012620395980775356, -0.0006279200315475464, 0.01354531105607748, 0.03257308900356293, -0.02790830098092556, 0.015160560607910156, 0.001807940425351262, -0.016621658578515053, -0.018846815451979637, -0.010676734149456024, -0.032278187572956085, 0.008418065495789051, -0.0019721463322639465, -0.013203495182096958, -0.003532102331519127, 0.02745254524052143, 0.018391061574220657, 0.015281202271580696, -0.0198923721909523, 0.0003814017109107226, -0.008036036044359207, -0.007432830519974232, 8.063682616921142e-05, 0.012332198210060596, 0.00033008737955242395, 0.004664788022637367, -0.011728992685675621, 0.015321415849030018, 0.0002636928984429687, 0.009765224531292915, 0.000641324557363987, 0.009061484597623348, 0.0007075095782056451, -0.008793393149971962, 0.014423309825360775, 0.023578627035021782, 0.007037395611405373, -0.0034952398855239153, 0.00458100950345397, 0.024718014523386955, 0.046460215002298355, -0.018887029960751534, 0.009939483366906643, 0.0018129671225324273, 0.0063269538804888725, -0.0009014568640850484, 0.00012692445307038724, -0.0036292856093496084, -0.018645746633410454, 0.021273041144013405, 0.024530351161956787, 0.0010497448965907097, -0.018055947497487068, -0.008062845095992088, 0.01774764247238636, 0.036299556493759155, -0.004715055227279663, -0.020884308964014053, -0.0018883678130805492, 0.005217726342380047, 0.012037297710776329, -0.02521398290991783, -0.00697707524523139, 0.0004896854516118765, 0.004074987024068832, 0.01428926456719637, 0.01242602989077568, 0.003686254844069481, 0.02930237539112568, -0.00599519070237875, -0.00840466096997261, -0.010247788392007351, -0.030160266906023026, -0.01947683095932007, 0.029624084010720253, 0.007640601135790348, 0.027532972395420074, 0.005619863048195839, -0.014517142437398434, 0.004389994312077761, 0.019543852657079697, 0.02458396926522255, -0.02183603309094906, -0.011916656978428364, -0.01130674872547388, 0.0002685101644601673, 0.00026620624703355134, -0.023846717551350594, -0.02231859788298607, -0.020495576784014702, -0.01593802496790886, 0.0011779259657487273, 0.035602521151304245, 0.006427488289773464, 0.03136667609214783, 0.005861145444214344, -0.007238463964313269, 0.017707427963614464, 0.03624593839049339, 0.000333229050738737, 0.01384691335260868, 0.00015080133744049817, 0.0025284357834607363, -0.013612333685159683, 0.008552111685276031, -0.018846815451979637, 0.003615880850702524, -0.048738993704319, -0.03270713612437248, 0.014771828427910805, -0.007084311451762915, 0.013578822836279869, -0.03377949818968773, -0.005998542066663504, 0.01502651534974575, 0.015080133453011513, 0.011112382635474205, 0.014946088194847107, -0.03292160853743553, 0.014852256514132023, 0.02793511003255844, 0.003793491283431649, 0.007493150886148214, -0.04444953054189682, 0.020495576784014702, 0.004510635510087013, -0.031044969335198402, -0.015053324401378632, 0.031795624643564224, -0.01384691335260868, -0.004601116292178631, 0.005391985643655062, 0.014369691722095013, 0.036058276891708374, -0.020991545170545578, 0.018042542040348053, -0.03308246284723282, -0.0001839985779952258, 0.0005324124940671027, -0.024530351161956787, -0.009376492351293564, 0.017881687730550766, -0.02742573618888855], index=0, object='embedding')], model='text-embedding-ada-002', object='list', usage=Usage(prompt_tokens=249, total_tokens=249))
        Returns:
            API response: The response from the API.
        """
        url = f"{self.client_url}/v1/embedding"
        data = {"input": text, "model":self.embedding_model}
        # 提交form格式数据
        headers = {'content-type': 'application/json'}
        # 提交form格式数据tokenizer
        r = requests.post(url, data=json.dumps(data), headers=headers)
        response = r.json()
        return response



    def get_embeddings_doc_split(self, corpus: list[list[str]], n_tries=3) -> list[dict]:
        """
        Computes the embeddings of a corpus for split documents.

        Args:
            self: The instance of the class.
            corpus (list[list[str]]): List of strings to embed, where each element is a document represented by a list of its chunks.
            n_tries (int, optional): Number of tries to make an API call (default is 3).

        Returns:
            List[dict]: A list of dictionaries, where each dictionary contains the embedding of the document, the text of the document, and a list of errors that occurred during the embedding process.
        """

        api_res_list = [] 
        for i in tqdm(range(len(corpus))):
            chunk_lis = corpus[i]
            api_res_doc = []
            for chunk_n, chunk in enumerate(chunk_lis):

                for i in range(n_tries + 1):
                    try: 
                        api_res_doc.append(
                            {"api_res": self.make_api_call(chunk), 
                            "error": None }
                         )
                        break
                    except Exception as e:
                            print(f"Error {e} occured for chunk {chunk_n} of document {i}")
                            print(chunk)
                            print("Trying again.")
                            if i == n_tries: 
                                print("Maximum number of tries reached. Skipping chunk.")
                                api_res_doc.append(
                                    {"api_res": None, 
                                    "error": e })


            # average the embeddings of the chunks
            emb_lis = []
            for api_res in api_res_doc:
                if api_res["api_res"] is not None:
                    emb_lis.append(np.array(api_res["api_res"]["data"][0]["embedding"]))
            text = " ".join(chunk_lis)
            embedding = np.mean(emb_lis, axis = 0)
            api_res_list.append(
                {"embedding": embedding, 
                "text": text, 
                "errors": [api_res["error"] for api_res in api_res_doc]}
                )
        return api_res_list

    def convert_api_res_list(self, api_res_list: list[dict]) -> dict:
        """
        Converts the api_res list into a dictionary containing the embeddings as a matrix and the corpus as a list of strings.

        Args:
            self: The instance of the class.
            api_res_list (list[dict]): List of dictionaries, where each dictionary contains the embedding of the document, the text of the document, and a list of errors that occurred during the embedding process.

        Returns:
            dict: A dictionary containing the embeddings as a matrix and the corpus as a list of strings.
        """


        embeddings = np.array([api_res["embedding"] for api_res in api_res_list])
        corpus = [api_res["text"] for api_res in api_res_list]
        errors = [api_res["errors"] for api_res in api_res_list]
        return {"embeddings": embeddings, "corpus": corpus, "errors": errors}


    def get_embeddings(self, corpus: list[str]) -> dict:
        """
        Computes the embeddings of a corpus.

        Args:
            self: The instance of the class.
            corpus (list[str]): List of strings to embed, where each element in the list is a document.

        Returns:
            dict: A dictionary containing the embeddings as a matrix and the corpus as a list of strings.
        """

        corpus_split = self.split_long_docs(corpus)
        corpus_emb = self.get_embeddings_doc_split(corpus_split)
        self.corpus_emb = corpus_emb
        res = self.convert_api_res_list(corpus_emb)
        return res